@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Http.Extensions
@model LoginViewModel
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Log In";
}
<style type="text/css">
    // solution 1:
    .datepicker { font-size: 0.875em; }
    /* solution 2: the original datepicker use 20px so replace with the following:*/

    .datepicker td, .datepicker th { width: 1.5em; height: 1.5em; }
</style>

<div class="row d-flex justify-content-center mt-5">
    <div class="card cardline" style="width: 400px;">
        <div class="card-header text-center headcolor" style="padding: 0px;">
            <h4>@ViewData["Title"]</h4>
            <p>Not registered yet?  <a href="https://msh2.azurewebsites.net/sign-up" class="text-dark"> Join Now</a></p>
            @if (ViewBag.ResetPass == true)
            {
                <span>Password has been reset. Please check your email for new password. </span>
            }
            @if (!string.IsNullOrEmpty(ViewBag.NewProvider))
            {
                <span>@ViewBag.NewProvider</span>
            }
            @*else
                {
                    <span style="color:red">Something went wrong </span>
                }*@
        </div>

        <div class="card-body">
            <div class="col-md-12">
                <form asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" id="frmlogin">
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    @* <div asp-validation-summary="All" class="text-danger"></div>*@


                    <div class="form-group">
                        <label asp-for="Username">Username</label>
                        <input asp-for="Username" class="form-control" id="txtusername" />
                        <span asp-validation-for="Username" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Password"></label>
                        <input asp-for="Password" class="form-control" id="txtpassword" />
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <div class="checkbox">
                            <label asp-for="RememberMe">
                                <input asp-for="RememberMe" />
                                @Html.DisplayNameFor(m => m.RememberMe)
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <ul class="nav">
                            <li>
                                <button type="button" class="btn btn-teal" id="btnLogin">Log in</button>
                            </li>
                            <li class="ml-auto">
                                <a href="@Url.Action("ForgotPassword","Account",new {returnUrl=@ViewData["ReturnUrl"] })" @*,asp-action="ForgotPassword"*@>Forgot your password?</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="forloginfooter">

</div>

<!-- DOB varification in case of multiple accounts -->
<form id="frmVarifyDOB" action="@Url.Action("Login", new { returnUrl = @ViewData["ReturnUrl"] })" method="post">
    <div id="dobVarificationModal" class="modal fade " role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header btn-teal">
                    <h4 class="modal-title text-center" >2-Step Verification</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-center pl-5 pr-5">We found more than one patient's account with entered email/phone, Please enter the patient's date of birth for verification.</p>
                    <br />
                    <div class="row">
                        <div class="col-sm-3 col-md-offset-1 text-right font-bold">
                            Date of Birth
                        </div>
                        <div class="col-sm-6">
                            @Html.HiddenFor(x => x.IsMultiAccount)
                            @Html.HiddenFor(x => x.Username, htmlAttributes: new { id = "hdnEmail" })
                            @Html.HiddenFor(x => x.Password, htmlAttributes: new { id = "hdnPassword" })
                            @Html.TextBoxFor(x => x.DateOfBirth, new { data_date_format = "mm/dd/yyyy", required = "required", @class = "form-control", @readonly = "readonly", autocomplete = "off", placeholder = "" })

                        </div>
                    </div>
                </div>
                <div class="modal-footer text-center">
                    <button id="btnDOBLogin" type="submit" class="btn btn-teal">Log In</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>
</form>
@*<div class="row">
        <div class="col-md-4">
            <section>
                <form asp-route-returnurl="@ViewData["ReturnUrl"]" method="post">
                    <h4>Use a local account to log in.</h4>
                    <hr />
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <div class="form-group">
                        <label asp-for="Email"></label>
                        <input asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Password"></label>
                        <input asp-for="Password" class="form-control" />
                        <span asp-validation-for="Password" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <div class="checkbox">
                            <label asp-for="RememberMe">
                                <input asp-for="RememberMe" />
                                @Html.DisplayNameFor(m => m.RememberMe)
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-default">Log in</button>
                    </div>
                    <div class="form-group">
                        <p>
                            <a asp-action="ForgotPassword">Forgot your password?</a>
                        </p>
                        <p>
                            <a asp-action="Register" asp-route-returnurl="@ViewData["ReturnUrl"]">Register as a new user?</a>
                        </p>
                    </div>
                </form>
            </section>
        </div>
        <div class="col-md-6 col-md-offset-2">
            <section>
                <h4>Use another service to log in.</h4>
                <hr />
                @{
                    var loginProviders = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();
                    if (loginProviders.Count == 0)
                    {
                        <div>
                            <p>
                                There are no external authentication services configured. See <a href="https://go.microsoft.com/fwlink/?LinkID=532715">this article</a>
                                for details on setting up this ASP.NET application to support logging in via external services.
                            </p>
                        </div>
                    }
                    else
                    {
                        <form asp-action="ExternalLogin" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="form-horizontal">
                            <div>
                                <p>
                                    @foreach (var provider in loginProviders)
                                    {
                                        <button type="submit" class="btn btn-default" name="provider" value="@provider.Name" title="Log in using your @provider.DisplayName account">@provider.Name</button>
                                    }
                                </p>
                            </div>
                        </form>
                    }
                }
            </section>
        </div>
    </div>*@

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    @*<script src="~/js/Bootstrapdatetime.js"></script>*@
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>
   

    <script>
    $(document).ready(function () {
        $('#DateOfBirth').datepicker({
            //todayDate: true,
            //minView: 2,
            //autoclose: 1,
            endDate: "+0d",
            weekStart: 1,
            //daysOfWeekHighlighted: "6,0",
            autoclose: true,
            todayHighlight: true
           
        });
        //$('#DateOfBirth').click(function () {
        //    var popup = $(this).offset();
        //    var popupTop = popup.top - 40;
        //    $('.ui-datepicker').css({
        //        'top': popupTop
        //    });
        //});
        $('#btnLogin').on('click', function (e) {
            debugger
                var returnUrl = '@ViewBag.ReturnUrl';
               /* e.preventDefault();*/
                var element = this;
                var valid = $("#frmlogin").valid();
                if (valid) {
                    var validate = {};
                    validate.Username = $('#txtusername').val();
                    validate.Password = $('#txtpassword').val();
                    $('#emailloginhidden').val(validate.Username);
                    $('#emailpasswordhidden').val(validate.Password);
                    //if (!returnUrl) {
                        $.ajax({
                            url: '/Account/CheckUserLoginPatient',
                            type: "GET",
                            data: { userName: validate.Username},
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                var check = data.singleUser;
                                console.log(check);
                                if (JSON.parse(check) === true) {
                                    $('#IsMultiAccount').val('true');
                                    debbugger;
                                    $('#hdnEmail').val($('#txtusername').val());
                                    $('#hdnPassword').val($('#txtpassword').val());
                                    $('#dobVarificationModal').modal('show');
                                    return false;
                                }
                                else {
                                    $(element).closest("form").submit();
                                }

                            }
                        });
                }
            });
    });
    </script>

}
